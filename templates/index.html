<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>
      Semantic Vault - AI Knowledge
      Assistant
    </title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        background: #ececf1;
      }

      body {
        font-family: -apple-system,
          BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue",
          Arial, sans-serif;
        background: #ececf1 !important;
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      .app-wrapper {
        display: flex;
        gap: 0;
        width: 100%;
        height: 100vh;
        background: #ececf1 !important;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: #202123;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 1px solid #4d4d4f;
      }

      .sidebar-header {
        padding: 16px;
        background: #202123;
        border-bottom: 1px solid #4d4d4f;
      }

      .sidebar-header h2 {
        font-size: 1.1em;
        margin-bottom: 12px;
        color: #ececf1;
        font-weight: 600;
      }

      .new-chat-btn {
        width: 100%;
        padding: 11px;
        background: transparent;
        border: 1px solid #4d4d4f;
        border-radius: 6px;
        color: #ececf1;
        font-weight: 500;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .new-chat-btn:hover {
        background: #343541;
        border-color: #565869;
      }

      .chat-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .chat-list::-webkit-scrollbar {
        width: 6px;
      }

      .chat-list::-webkit-scrollbar-track {
        background: #202123;
      }

      .chat-list::-webkit-scrollbar-thumb {
        background: #4d4d4f;
        border-radius: 10px;
      }

      .chat-list::-webkit-scrollbar-thumb:hover {
        background: #565869;
      }

      .chat-item {
        padding: 11px 12px;
        margin: 2px 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 1px solid transparent;
        color: #ececf1;
      }

      .chat-item:hover {
        background: #343541;
      }

      .chat-item.active {
        background: #343541;
        color: #ececf1;
      }

      .chat-item-title {
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 4px;
        word-break: break-word;
      }

      .chat-item-meta {
        font-size: 0.75em;
        opacity: 0.7;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-item-delete {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 20px;
        height: 20px;
        border-radius: 4px;
        background: transparent;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s ease;
        font-size: 16px;
        color: #8e8ea0;
      }

      .chat-item:hover
        .chat-item-delete {
        opacity: 1;
      }

      .chat-item.active
        .chat-item-delete {
        color: #ececf1;
      }

      .chat-item-delete:hover {
        background: #565869;
        color: #ececf1;
      }

      /* Main Container */
      .container {
        flex: 1;
        background: #ececf1 !important;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-width: 0;
      }

      .header {
        background: #ececf1 !important;
        color: #202123;
        padding: 20px 30px;
        text-align: center;
        border-bottom: 1px solid #d1d5db;
      }

      .header h1 {
        font-size: 1.8em;
        margin-bottom: 8px;
        font-weight: 600;
        color: #202123;
      }

      .header p {
        font-size: 0.95em;
        color: #565869;
        margin-bottom: 12px;
      }

      .stats {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .stat-badge {
        background: #ffffff;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85em;
        color: #565869;
        border: 1px solid #d1d5db;
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        background: #ececf1 !important;
      }

      .chat-container::-webkit-scrollbar {
        width: 8px;
      }

      .chat-container::-webkit-scrollbar-track {
        background: #ececf1;
      }

      .chat-container::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 4px;
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      .welcome-message {
        text-align: center;
        color: #565869;
        padding: 60px 20px;
        background: #ececf1 !important;
      }

      .welcome-message h2 {
        font-size: 1.5em;
        margin-bottom: 12px;
        color: #202123;
        font-weight: 600;
      }

      .welcome-message p {
        font-size: 0.95em;
        line-height: 1.6;
        color: #565869;
      }

      .message {
        display: flex;
        gap: 12px;
        animation: slideIn 0.3s ease-out;
        background: transparent;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        flex-shrink: 0;
      }

      .message.user .message-avatar {
        background: #10a37f;
        color: white;
      }

      .message.assistant
        .message-avatar {
        background: #19c37d;
        color: white;
      }

      .message-content {
        max-width: 75%;
        padding: 15px 20px;
        border-radius: 18px;
        line-height: 1.6;
        word-wrap: break-word;
      }

      .message.user .message-content {
        background: #ffffff;
        color: #202123;
        border-bottom-right-radius: 4px;
        border: 1px solid #e5e5e6;
      }

      .message.assistant
        .message-content {
        background: #ffffff;
        color: #202123;
        border-bottom-left-radius: 4px;
        border: 1px solid #e5e5e6;
      }

      .loading {
        display: flex;
        gap: 8px;
        padding: 15px 20px;
      }

      .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #565869;
        animation: bounce 1.4s infinite
          ease-in-out both;
      }

      .loading-dot:nth-child(1) {
        animation-delay: -0.32s;
      }

      .loading-dot:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
        }
        40% {
          transform: scale(1);
        }
      }

      .input-container {
        padding: 20px 24px;
        background: #ececf1 !important;
        border-top: 1px solid #d1d5db;
      }

      .input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      .input-wrapper {
        flex: 1;
        position: relative;
      }

      .input-field {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        font-size: 0.95em;
        font-family: inherit;
        outline: none;
        transition: all 0.2s ease;
        resize: none;
        max-height: 200px;
        background: #ffffff;
        color: #202123;
      }

      .input-field:focus {
        border-color: #10a37f;
        box-shadow: 0 0 0 2px
          rgba(16, 163, 127, 0.1);
      }

      .submit-btn {
        padding: 12px 24px;
        background: #10a37f;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .submit-btn:hover:not(:disabled) {
        background: #0d8968;
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #fecaca;
        margin: 10px 0;
      }

      .empty-state {
        text-align: center;
        color: #8e8ea0;
        padding: 20px;
        font-size: 0.85em;
      }

      @media (max-width: 768px) {
        .app-wrapper {
          flex-direction: column;
          width: 100vw;
          height: 100vh;
        }

        .sidebar {
          width: 100%;
          max-height: 250px;
          border-right: none;
          border-bottom: 1px solid
            #4d4d4f;
        }

        .container {
          min-height: 0;
          flex: 1;
        }

        .chat-container {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-wrapper">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>üí¨ Chat History</h2>
          <button
            class="new-chat-btn"
            id="newChatBtn"
          >
            + New Chat
          </button>
        </div>
        <div
          class="chat-list"
          id="chatList"
        >
          <div class="empty-state">
            Loading chats...
          </div>
        </div>
      </div>

      <!-- Main Container -->
      <div class="container">
        <div
          class="header"
          style="
            background: #ececf1 !important;
          "
        >
          <h1>üîç Semantic Vault</h1>
          <p>
            AI-Powered Knowledge
            Assistant
          </p>
          <div class="stats">
            <div
              class="stat-badge"
              id="model-badge"
            >
              Model: {{ model }}
            </div>
            <div
              class="stat-badge"
              id="notes-badge"
            >
              Loading...
            </div>
          </div>
        </div>

        <div
          class="chat-container"
          id="chatContainer"
          style="
            background: #ececf1 !important;
          "
        >
          <div class="welcome-message">
            <h2>
              Welcome to Semantic Vault!
            </h2>
            <p>
              Ask me anything about your
              notes. I'll search through
              your knowledge base and
              provide you with relevant
              answers.
            </p>
          </div>
        </div>

        <div
          class="input-container"
          style="
            background: #ececf1 !important;
          "
        >
          <form
            class="input-form"
            id="questionForm"
          >
            <div class="input-wrapper">
              <textarea
                class="input-field"
                id="questionInput"
                placeholder="Type your question here..."
                rows="1"
                required
              ></textarea>
            </div>
            <button
              type="submit"
              class="submit-btn"
              id="submitBtn"
            >
              Ask
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      const chatContainer =
        document.getElementById(
          "chatContainer"
        );
      const questionForm =
        document.getElementById(
          "questionForm"
        );
      const questionInput =
        document.getElementById(
          "questionInput"
        );
      const submitBtn =
        document.getElementById(
          "submitBtn"
        );
      const notesBadge =
        document.getElementById(
          "notes-badge"
        );
      const chatList =
        document.getElementById(
          "chatList"
        );
      const newChatBtn =
        document.getElementById(
          "newChatBtn"
        );

      let currentChatId = null;

      // Auto-resize textarea
      questionInput.addEventListener(
        "input",
        function () {
          this.style.height = "auto";
          this.style.height =
            Math.min(
              this.scrollHeight,
              120
            ) + "px";
        }
      );

      // Load stats on page load
      fetch("/api/stats")
        .then((res) => res.json())
        .then((data) => {
          notesBadge.textContent = `${data.note_count} notes`;
        })
        .catch((err) => {
          notesBadge.textContent =
            "Stats unavailable";
        });

      // Load chat history
      function loadChatHistory() {
        fetch("/api/chats")
          .then((res) => res.json())
          .then((data) => {
            displayChatList(
              data.chats || []
            );
          })
          .catch((err) => {
            console.error(
              "Error loading chats:",
              err
            );
            chatList.innerHTML =
              '<div class="empty-state">Error loading chats</div>';
          });
      }

      function displayChatList(chats) {
        if (chats.length === 0) {
          chatList.innerHTML =
            '<div class="empty-state">No chat history yet</div>';
          return;
        }

        chatList.innerHTML = chats
          .map(
            (chat) => `
          <div class="chat-item ${
            chat.id === currentChatId
              ? "active"
              : ""
          }" data-chat-id="${chat.id}">
            <button class="chat-item-delete" onclick="deleteChat('${
              chat.id
            }', event)">√ó</button>
            <div class="chat-item-title">${escapeHtml(
              chat.title
            )}</div>
            <div class="chat-item-meta">
              <span>${
                chat.message_count
              } msgs</span>
              <span>${formatDate(
                chat.updated
              )}</span>
            </div>
          </div>
        `
          )
          .join("");

        // Add click handlers
        chatList
          .querySelectorAll(
            ".chat-item"
          )
          .forEach((item) => {
            item.addEventListener(
              "click",
              (e) => {
                if (
                  e.target.classList.contains(
                    "chat-item-delete"
                  )
                )
                  return;
                const chatId =
                  item.dataset.chatId;
                loadChat(chatId);
              }
            );
          });
      }

      function loadChat(chatId) {
        currentChatId = chatId;
        fetch(`/api/chat/${chatId}`)
          .then((res) => res.json())
          .then((data) => {
            // Clear chat container
            chatContainer.innerHTML =
              "";

            // Display messages
            data.messages.forEach(
              (msg) => {
                addMessage(
                  msg.role,
                  msg.content,
                  false,
                  false
                );
              }
            );

            // Update active state in sidebar
            chatList
              .querySelectorAll(
                ".chat-item"
              )
              .forEach((item) => {
                item.classList.toggle(
                  "active",
                  item.dataset
                    .chatId === chatId
                );
              });

            // Scroll to bottom
            chatContainer.scrollTop =
              chatContainer.scrollHeight;
          })
          .catch((err) => {
            console.error(
              "Error loading chat:",
              err
            );
            addMessage(
              "assistant",
              "Error loading chat history.",
              true
            );
          });
      }

      function newChat() {
        currentChatId = null;
        chatContainer.innerHTML = `
          <div class="welcome-message">
            <h2>Welcome to Semantic Vault!</h2>
            <p>Ask me anything about your notes. I'll search through your knowledge base and provide you with relevant answers.</p>
          </div>
        `;

        // Update active state
        chatList
          .querySelectorAll(
            ".chat-item"
          )
          .forEach((item) => {
            item.classList.remove(
              "active"
            );
          });

        questionInput.focus();
      }

      function deleteChat(
        chatId,
        event
      ) {
        event.stopPropagation();
        if (
          !confirm("Delete this chat?")
        )
          return;

        fetch(`/api/chat/${chatId}`, {
          method: "DELETE"
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              if (
                currentChatId === chatId
              ) {
                newChat();
              }
              loadChatHistory();
            }
          })
          .catch((err) => {
            console.error(
              "Error deleting chat:",
              err
            );
          });
      }

      newChatBtn.addEventListener(
        "click",
        newChat
      );

      // Handle form submission
      questionForm.addEventListener(
        "submit",
        async (e) => {
          e.preventDefault();

          const question =
            questionInput.value.trim();
          if (!question) return;

          // Remove welcome message if present
          const welcomeMsg =
            chatContainer.querySelector(
              ".welcome-message"
            );
          if (welcomeMsg) {
            welcomeMsg.remove();
          }

          // Add user message
          addMessage("user", question);
          questionInput.value = "";
          questionInput.style.height =
            "auto";

          // Disable form
          submitBtn.disabled = true;
          submitBtn.textContent =
            "Thinking...";

          // Show loading indicator
          const loadingId =
            addLoadingMessage();

          try {
            const response =
              await fetch("/api/ask", {
                method: "POST",
                headers: {
                  "Content-Type":
                    "application/json"
                },
                body: JSON.stringify({
                  question,
                  chat_id: currentChatId
                })
              });

            const data =
              await response.json();

            // Remove loading indicator
            removeMessage(loadingId);

            if (
              response.ok &&
              data.answer
            ) {
              addMessage(
                "assistant",
                data.answer
              );

              // Update current chat ID if this was a new chat
              if (
                !currentChatId &&
                data.chat_id
              ) {
                currentChatId =
                  data.chat_id;
                loadChatHistory(); // Refresh chat list
              }
            } else {
              addMessage(
                "assistant",
                data.error ||
                  "Sorry, I encountered an error. Please try again.",
                true
              );
            }
          } catch (error) {
            removeMessage(loadingId);
            addMessage(
              "assistant",
              "Network error. Please check your connection and try again.",
              true
            );
          } finally {
            // Re-enable form
            submitBtn.disabled = false;
            submitBtn.textContent =
              "Ask";
            questionInput.focus();
          }
        }
      );

      function addMessage(
        type,
        content,
        isError = false,
        animate = true
      ) {
        const messageDiv =
          document.createElement("div");
        messageDiv.className = `message ${type}`;
        messageDiv.id = `msg-${Date.now()}-${Math.random()}`;
        if (!animate) {
          messageDiv.style.animation =
            "none";
        }

        const avatar =
          document.createElement("div");
        avatar.className =
          "message-avatar";
        avatar.textContent =
          type === "user" ? "üë§" : "ü§ñ";

        const messageContent =
          document.createElement("div");
        messageContent.className =
          isError
            ? "error-message"
            : "message-content";
        messageContent.textContent =
          content;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(
          messageContent
        );
        chatContainer.appendChild(
          messageDiv
        );

        // Scroll to bottom
        chatContainer.scrollTop =
          chatContainer.scrollHeight;

        return messageDiv.id;
      }

      function addLoadingMessage() {
        const messageDiv =
          document.createElement("div");
        messageDiv.className =
          "message assistant";
        messageDiv.id = `loading-${Date.now()}`;

        const avatar =
          document.createElement("div");
        avatar.className =
          "message-avatar";
        avatar.textContent = "ü§ñ";

        const loading =
          document.createElement("div");
        loading.className = "loading";
        for (let i = 0; i < 3; i++) {
          const dot =
            document.createElement(
              "div"
            );
          dot.className = "loading-dot";
          loading.appendChild(dot);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(loading);
        chatContainer.appendChild(
          messageDiv
        );

        chatContainer.scrollTop =
          chatContainer.scrollHeight;

        return messageDiv.id;
      }

      function removeMessage(id) {
        const message =
          document.getElementById(id);
        if (message) {
          message.remove();
        }
      }

      function escapeHtml(text) {
        const div =
          document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(
          dateString
        );
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(
          diff / 60000
        );

        if (minutes < 1)
          return "Just now";
        if (minutes < 60)
          return `${minutes}m ago`;
        const hours = Math.floor(
          minutes / 60
        );
        if (hours < 24)
          return `${hours}h ago`;
        const days = Math.floor(
          hours / 24
        );
        if (days < 7)
          return `${days}d ago`;
        return date.toLocaleDateString();
      }

      // Allow Enter to submit (Shift+Enter for new line)
      questionInput.addEventListener(
        "keydown",
        (e) => {
          if (
            e.key === "Enter" &&
            !e.shiftKey
          ) {
            e.preventDefault();
            questionForm.dispatchEvent(
              new Event("submit")
            );
          }
        }
      );

      // Load chat history on page load
      loadChatHistory();
    </script>
  </body>
</html>
